<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèîÔ∏è Excursiones Grupo Senderismo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 15px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c5530 0%, #5cb85c 100%);
      color: white;
      padding: 25px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .auth-section {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px 20px;
      margin: 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .auth-section input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9em;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary { background: #4a90e2; color: white; }
    .btn-primary:hover { background: #357abd; transform: translateY(-1px); }
    
    .btn-success { background: #27ae60; color: white; }
    .btn-success:hover { background: #229954; }
    
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    
    .btn-warning { background: #f39c12; color: white; }
    .btn-warning:hover { background: #e67e22; }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.8em;
    }

    .admin-panel {
      background: #f8f9fa;
      border-top: 1px solid #dee2e6;
      padding: 20px;
      display: none;
    }

    .admin-panel.show {
      display: block;
    }

    .admin-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .excursion-card {
      margin: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }

    .excursion-header {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      color: white;
      padding: 20px;
      position: relative;
    }

    .excursion-actions {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 5px;
    }

    .excursion-title {
      font-size: 1.4em;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .excursion-date {
      font-size: 1em;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .excursion-details {
      font-size: 0.9em;
      opacity: 0.8;
      line-height: 1.4;
    }

    .excursion-details a {
      color: #74b9ff;
      text-decoration: none;
    }

    .excursion-details a:hover {
      text-decoration: underline;
    }

    .participant-count {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .participants-section {
      padding: 20px;
    }

    .participants-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .participant-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .participant-item:hover {
      background: #e3f2fd;
      border-color: #4a90e2;
      transform: translateY(-1px);
    }

    .participant-item.highlight {
      animation: highlightAnim 2s ease-out;
    }

    .participant-info {
      flex: 1;
    }

    .participant-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .participant-notes {
      font-size: 0.85em;
      color: #666;
      font-style: italic;
      margin-top: 2px;
    }

    .participant-actions {
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .participant-item:hover .participant-actions {
      opacity: 1;
    }

    .add-participant-section {
      background: #f0f8ff;
      padding: 15px;
      border-top: 1px solid #e9ecef;
      border-radius: 0 0 12px 12px;
    }

    .add-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .form-group label {
      font-size: 0.9em;
      font-weight: 600;
      color: #555;
    }

    .form-control {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9em;
      min-width: 120px;
    }

    .form-control:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }

    .stats-bar {
      background: #f8f9fa;
      padding: 12px 20px;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      font-size: 0.9em;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-number {
      font-weight: 700;
      color: #4a90e2;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #2c3e50;
    }

    .close {
      float: right;
      font-size: 24px;
      cursor: pointer;
      color: #aaa;
    }

    .close:hover {
      color: #000;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 10px 15px;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      margin: 10px 0;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 10px 15px;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      margin: 10px 0;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes highlightAnim {
      from { background: #fff3cd; }
      to { background: #f8f9fa; }
    }

    @media (max-width: 768px) {
      .participants-grid {
        grid-template-columns: 1fr;
      }
      
      .add-form {
        flex-direction: column;
      }
      
      .form-control {
        min-width: 100%;
      }
      
      .stats-bar {
        flex-direction: column;
        gap: 10px;
      }
      
      .auth-section {
        flex-direction: column;
      }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèîÔ∏è Excursiones Grupo Senderismo</h1>
      <p>Sistema de Inscripciones ‚Ä¢ Temporada 2024/2025</p>
    </div>

    <!-- Secci√≥n de autenticaci√≥n para admin -->
    <div class="auth-section" id="authSection">
      <span>üîê <strong>Admin:</strong></span>
      <input type="password" id="adminPassword" placeholder="Contrase√±a de administrador">
      <button class="btn btn-primary" onclick="checkAdmin()">Acceder</button>
    </div>

    <!-- Panel de administraci√≥n -->
    <div class="admin-panel" id="adminPanel">
      <h3>üõ†Ô∏è Panel de Administraci√≥n</h3>
      <div class="admin-controls">
        <button class="btn btn-success" onclick="showNewExcursionModal()">‚ûï Nueva Excursi√≥n</button>
        <button class="btn btn-primary" onclick="loadExcursions()">üîÑ Recargar Datos</button>
        <button class="btn btn-warning" onclick="exportData()">üìä Exportar CSV</button>
      </div>
    </div>

    <!-- Contenedor de excursiones -->
    <div id="excursionsContainer">
      <div style="text-align: center; padding: 40px; color: #666;">
        <div class="loading"></div>
        <p>Cargando excursiones...</p>
      </div>
    </div>
  </div>

  <!-- Modal para nueva excursi√≥n -->
  <div id="newExcursionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close" onclick="closeModal('newExcursionModal')">&times;</span>
        <h2 class="modal-title">‚ûï Nueva Excursi√≥n</h2>
      </div>
      <form id="newExcursionForm">
        <div class="form-group">
          <label>Nombre de la Excursi√≥n *</label>
          <input type="text" class="form-control" id="newExcursionName" placeholder="ej: Montserrat per Sant Jeroni" required>
        </div>
        <div class="form-group">
          <label>Fecha y Hora *</label>
          <input type="text" class="form-control" id="newExcursionDate" placeholder="ej: S√°bado 15 de Octubre ‚Ä¢ 9:00h" required>
        </div>
        <div class="form-group">
          <label>Detalles</label>
          <textarea class="form-control" id="newExcursionDetails" rows="3" placeholder="üìç Punto encuentro ‚Ä¢ üìè distancia, desnivel ‚Ä¢ ‚è±Ô∏è duraci√≥n ‚Ä¢ üîó https://enlace-ruta.com"></textarea>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <button type="submit" class="btn btn-success">Crear Excursi√≥n</button>
          <button type="button" class="btn" onclick="closeModal('newExcursionModal')" style="background: #ccc; margin-left: 10px;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para editar excursi√≥n -->
  <div id="editExcursionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close" onclick="closeModal('editExcursionModal')">&times;</span>
        <h2 class="modal-title">‚úèÔ∏è Editar Excursi√≥n</h2>
      </div>
      <form id="editExcursionForm">
        <input type="hidden" id="editExcursionId">
        <div class="form-group">
          <label>Nombre de la Excursi√≥n *</label>
          <input type="text" class="form-control" id="editExcursionName" required>
        </div>
        <div class="form-group">
          <label>Fecha y Hora *</label>
          <input type="text" class="form-control" id="editExcursionDate" required>
        </div>
        <div class="form-group">
          <label>Detalles</label>
          <textarea class="form-control" id="editExcursionDetails" rows="3"></textarea>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <button type="submit" class="btn btn-success">Guardar Cambios</button>
          <button type="button" class="btn" onclick="closeModal('editExcursionModal')" style="background: #ccc; margin-left: 10px;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configuraci√≥n
    const Excursiones2024 = "senderismo2024"; // Cambia esta contrase√±a
    const https://script.google.com/macros/s/AKfycbyxKQqyuFzm8yka-m53gj5fstEHMX1UU2ME9UD35H3mNVy3j80XzkkHY0q6wj7JBkC11g/exec = "https://script.google.com/macros/s/AKfycbwabKBo_LrvEdRCP_kJ7G1K1ivcSQ-TAokpxVFhRk71Rzi0bxUhemnEmh605Y6V4GsDwQ/exec";
    
    let isAdmin = false;
    let excursions = [];
    let participants = [];

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      loadExcursions();
    });

    // Autenticaci√≥n admin
    function checkAdmin() {
      const password = document.getElementById('adminPassword').value;
      if (password === Excursiones2024) {
        isAdmin = true;
        document.getElementById('adminPanel').classList.add('show');
        document.getElementById('authSection').style.display = 'none';
        showMessage('‚úÖ Acceso de administrador concedido', 'success');
      } else {
        showMessage('‚ùå Contrase√±a incorrecta', 'error');
      }
    }

    // Cargar excursiones desde Google Sheets
    async function loadExcursions() {
      try {
        showLoading();
        const response = await fetch(`${https://script.google.com/macros/s/AKfycbyxKQqyuFzm8yka-m53gj5fstEHMX1UU2ME9UD35H3mNVy3j80XzkkHY0q6wj7JBkC11g/exec}?action=getExcursions`);
        const data = await response.json();
        
        if (data.success) {
          excursions = data.excursions || [];
          participants = data.participants || [];
          renderExcursions();
        } else {
          throw new Error(data.error || 'Error al cargar datos');
        }
      } catch (error) {
        console.error('Error:', error);
        showError('Error al cargar las excursiones. Mostrando datos de ejemplo.');
        loadExampleData();
      }
    }

    // Datos de ejemplo si falla la conexi√≥n
    function loadExampleData() {
      excursions = [
        {
          id: 'ejemplo1',
          nombre: 'üèîÔ∏è Can Candi i les Foradades',
          fecha: 'Mi√©rcoles 24 de Septiembre ‚Ä¢ 9:00h',
          detalles: 'üìç Gasolinera Q8 ‚Ä¢ üìè 10km, 450m desnivel ‚Ä¢ ‚è±Ô∏è 3h aprox'
        }
      ];
      participants = [];
      renderExcursions();
    }

    // Mostrar loading
    function showLoading() {
      document.getElementById('excursionsContainer').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
          <div class="loading"></div>
          <p>Cargando excursiones...</p>
        </div>
      `;
    }

    // Renderizar excursiones
    function renderExcursions() {
      const container = document.getElementById('excursionsContainer');
      
      if (excursions.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 1.2em;">üìã No hay excursiones programadas</p>
            <p>El administrador puede a√±adir nuevas excursiones desde el panel de control.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = '';
      
      excursions.forEach(excursion => {
        const excursionParticipants = participants.filter(p => p.excursionId === excursion.id);
        const petCount = excursionParticipants.filter(p => p.notas && p.notas.toLowerCase().includes('perro')).length;
        
        const card = document.createElement('div');
        card.className = 'excursion-card';
        card.innerHTML = `
          <div class="excursion-header">
            <div class="participant-count">${excursionParticipants.length} inscrito${excursionParticipants.length !== 1 ? 's' : ''}</div>
            ${isAdmin ? `
              <div class="excursion-actions">
                <button class="btn btn-warning btn-small" onclick="editExcursion('${excursion.id}')">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-small" onclick="deleteExcursion('${excursion.id}')">üóëÔ∏è</button>
              </div>
            ` : ''}
            <div class="excursion-title">${excursion.nombre}</div>
            <div class="excursion-date">üìÖ ${excursion.fecha}</div>
            <div class="excursion-details">${makeLinksClickable(excursion.detalles || '')}</div>
          </div>
          <div class="participants-section">
            <div class="participants-grid" data-excursion-id="${excursion.id}">
              ${excursionParticipants.map(participant => `
                <div class="participant-item">
                  <div class="participant-info">
                    <div class="participant-name">${participant.nombre}</div>
                    ${participant.notas ? `<div class="participant-notes">${participant.notas}</div>` : ''}
                  </div>
                  ${isAdmin ? `
                    <div class="participant-actions">
                      <button class="btn btn-danger btn-small" onclick="removeParticipant('${participant.id}', '${excursion.id}')">‚úï</button>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
            <div class="add-participant-section">
              <div class="add-form">
                <div class="form-group">
                  <label>Nombre y Inicial Apellido *</label>
                  <input type="text" class="form-control participant-name-input" placeholder="ej: Juan M." maxlength="30">
                </div>
                <div class="form-group">
                  <label>Notas (opcional)</label>
                  <input type="text" class="form-control participant-notes-input" placeholder="ej: con perro, ruta corta..." maxlength="100">
                </div>
                <div class="form-group">
                  <button class="btn btn-success" onclick="addParticipant('${excursion.id}', this)">‚ûï Apuntarme</button>
                </div>
              </div>
            </div>
          </div>
          <div class="stats-bar">
            <div class="stat-item">
              <span>üë• Inscritos:</span>
              <span class="stat-number">${excursionParticipants.length}</span>
            </div>
            <div class="stat-item">
              <span>üê∂ Con mascota:</span>
              <span class="stat-number">${petCount}</span>
            </div>
            <div class="stat-item">
              <span>üì± √öltima actualizaci√≥n:</span>
              <span class="stat-number">${new Date().toLocaleTimeString()}</span>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    // Convertir URLs en enlaces clicables
    function makeLinksClickable(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
    }

    // A√±adir participante
    async function addParticipant(excursionId, button) {
      const section = button.closest('.add-participant-section');
      const nameInput = section.querySelector('.participant-name-input');
      const notesInput = section.querySelector('.participant-notes-input');

      const name = nameInput.value.trim();
      if (!name) {
        showMessage('‚ùå Por favor, introduce tu nombre y inicial del apellido', 'error');
        return;
      }

      // Validar formato nombre + inicial
      if (!/^[A-Za-z√Ä-√ø\u00f1\u00d1\s]+ [A-Za-z√Ä-√ø\u00f1\u00d1]\.?$/.test(name)) {
        showMessage('‚ùå Por favor, usa el formato "Nombre Inicial." (ej: Juan M.)', 'error');
        return;
      }

      // Verificar si ya existe
      const existingParticipant = participants.find(p => 
        p.excursionId === excursionId && 
        p.nombre.toLowerCase() === name.toLowerCase()
      );
      
      if (existingParticipant) {
        showMessage('‚ùå Ya hay alguien apuntado con ese nombre en esta excursi√≥n', 'error');
        return;
      }

      const notes = notesInput.value.trim();
      
      try {
        button.disabled = true;
        button.innerHTML = '<div class="loading" style="width: 15px; height: 15px;"></div>';
        
        const response = await fetch(https://script.google.com/macros/s/AKfycbyxKQqyuFzm8yka-m53gj5fstEHMX1UU2ME9UD35H3mNVy3j80XzkkHY0q6wj7JBkC11g/exec, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'addParticipant',
            excursionId: excursionId,
            nombre: name,
            notas: notes
          })
        });

        const result = await response.json();
        
        if (result.success) {
          closeModal('editExcursionModal');
          showMessage('‚úÖ Excursi√≥n actualizada correctamente', 'success');
          loadExcursions();
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showMessage('‚ùå Error al actualizar la excursi√≥n', 'error');
      }
    });

    // Eliminar excursi√≥n
    async function deleteExcursion(excursionId) {
      if (!isAdmin) return;
      
      const excursion = excursions.find(e => e.id === excursionId);
      if (!excursion) return;

      if (!confirm(`¬øEst√°s seguro de eliminar la excursi√≥n "${excursion.nombre}"?\n\nEsto tambi√©n eliminar√° todos los participantes apuntados.`)) {
        return;
      }

      try {
        const response = await fetch(https://script.google.com/macros/s/AKfycbyxKQqyuFzm8yka-m53gj5fstEHMX1UU2ME9UD35H3mNVy3j80XzkkHY0q6wj7JBkC11g/exec, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'deleteExcursion',
            id: excursionId
          })
        });

        const result = await response.json();
        
        if (result.success) {
          showMessage('‚úÖ Excursi√≥n eliminada correctamente', 'success');
          loadExcursions();
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showMessage('‚ùå Error al eliminar la excursi√≥n', 'error');
      }
    }

    // Exportar datos
    function exportData() {
      if (!isAdmin) return;
      
      let csvContent = "Excursi√≥n,Fecha,Participante,Notas,Fecha Inscripci√≥n\n";
      
      excursions.forEach(excursion => {
        const excursionParticipants = participants.filter(p => p.excursionId === excursion.id);
        
        if (excursionParticipants.length === 0) {
          csvContent += `"${excursion.nombre}","${excursion.fecha}","Sin participantes","",""\n`;
        } else {
          excursionParticipants.forEach(participant => {
            csvContent += `"${excursion.nombre}","${excursion.fecha}","${participant.nombre}","${participant.notas || ''}","${participant.fechaInscripcion || ''}"\n`;
          });
        }
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `excursiones_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showMessage('üìä Datos exportados correctamente', 'success');
    }

    // Funciones de utilidad
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function showMessage(message, type) {
      // Remover mensajes anteriores
      const existingMessages = document.querySelectorAll('.error-message, .success-message');
      existingMessages.forEach(msg => msg.remove());

      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      
      const container = document.querySelector('.container');
      container.insertBefore(messageDiv, container.children[1]);
      
      // Auto-remover despu√©s de 5 segundos
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }

    function showError(message) {
      showMessage(message, 'error');
    }

    // Cerrar modales al hacer clic fuera
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    // Tecla Enter para a√±adir participante
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target.classList.contains('form-control')) {
        const addButton = e.target.closest('.add-participant-section')?.querySelector('.btn-success');
        if (addButton && !addButton.disabled) {
          const excursionId = e.target.closest('.excursion-card').querySelector('[data-excursion-id]').getAttribute('data-excursion-id');
          addParticipant(excursionId, addButton);
        }
      }
    });

    // Auto-reload cada 30 segundos para mantener datos actualizados
    setInterval(() => {
      if (!document.hidden) {
        loadExcursions();
      }
    }, 30000);

    console.log('‚úÖ Sistema de excursiones cargado correctamente');
  </script>
</body>
</html>.json();
        
        if (result.success) {
          nameInput.value = '';
          notesInput.value = '';
          showMessage('‚úÖ ¬°Te has apuntado correctamente!', 'success');
          loadExcursions(); // Recargar datos
        } else {
          throw new Error(result.error || 'Error al guardar');
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('‚ùå Error al apuntarte. Int√©ntalo de nuevo.', 'error');
      } finally {
        button.disabled = false;
        button.innerHTML = '‚ûï Apuntarme';
      }
    }

    // Eliminar participante (solo admin)
    async function removeParticipant(participantId, excursionId) {
      if (!isAdmin) return;
      
      if (!confirm('¬øEst√°s seguro de eliminar este participante?')) return;

      try {
        const response = await fetch(https://script.google.com/macros/s/AKfycbyxKQqyuFzm8yka-m53gj5fstEHMX1UU2ME9UD35H3mNVy3j80XzkkHY0q6wj7JBkC11g/exec, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'removeParticipant',
            participantId: participantId
          })
        });

        const result = await response.json();
        
        if (result.success) {
          showMessage('‚úÖ Participante eliminado', 'success');
          loadExcursions();
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showMessage('‚ùå Error al eliminar participante', 'error');
      }
    }

    // Nueva excursi√≥n
    function showNewExcursionModal() {
      if (!isAdmin) return;
      document.getElementById('newExcursionModal').style.display = 'block';
    }

    document.getElementById('newExcursionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('newExcursionName').value.trim();
      const date = document.getElementById('newExcursionDate').value.trim();
      const details = document.getElementById('newExcursionDetails').value.trim();
      
      if (!name || !date) {
        showMessage('‚ùå Completa al menos nombre y fecha', 'error');
        return;
      }

      try {
        const response = await fetch(https://script.google.com/macros/s/AKfycbyxKQqyuFzm8yka-m53gj5fstEHMX1UU2ME9UD35H3mNVy3j80XzkkHY0q6wj7JBkC11g/exec, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'addExcursion',
            nombre: name,
            fecha: date,
            detalles: details
          })
        });

        const result = await response.json();
        
        if (result.success) {
          closeModal('newExcursionModal');
          document.getElementById('newExcursionForm').reset();
          showMessage('‚úÖ Excursi√≥n creada correctamente', 'success');
          loadExcursions();
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showMessage('‚ùå Error al crear la excursi√≥n', 'error');
      }
    });

    // Editar excursi√≥n
    function editExcursion(excursionId) {
      if (!isAdmin) return;
      
      const excursion = excursions.find(e => e.id === excursionId);
      if (!excursion) return;

      document.getElementById('editExcursionId').value = excursionId;
      document.getElementById('editExcursionName').value = excursion.nombre;
      document.getElementById('editExcursionDate').value = excursion.fecha;
      document.getElementById('editExcursionDetails').value = excursion.detalles || '';
      
      document.getElementById('editExcursionModal').style.display = 'block';
    }

    document.getElementById('editExcursionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const id = document.getElementById('editExcursionId').value;
      const name = document.getElementById('editExcursionName').value.trim();
      const date = document.getElementById('editExcursionDate').value.trim();
      const details = document.getElementById('editExcursionDetails').value.trim();
      
      try {
        const response = await fetch(https://script.google.com/macros/s/AKfycbyxKQqyuFzm8yka-m53gj5fstEHMX1UU2ME9UD35H3mNVy3j80XzkkHY0q6wj7JBkC11g/exec, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'updateExcursion',
            id: id,
            nombre: name,
            fecha: date,
            detalles: details
          })
        });

        const result = await response